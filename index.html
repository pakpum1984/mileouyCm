<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DATATABLE FORM HTML</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
  integrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA=="
  crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href="https://fonts.googleapis.com/css2?family=Prompt&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
  <!-- DataTables CSS -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body {
      font-family: "Prompt", sans-serif;
      background-color: #f4f4f4;
    }
    #container {
      max-width: auto;
      margin: 5vh auto;
      border: 2px solid #ffffff;
      /* สีน้ำเงิน สามารถเปลี่ยนสีได้ */
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0px 0px 10px 0px rgba(0, 0, 0, 0.5);
      /* เพิ่มเงาดำ */
    }
    .spinner-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100%; /* ให้ Spinner ทำเต็มส่วนสูงของ #dataTable */
    }
   
  </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg navbar bg-primary">
        <div class="container-fluid">
          <a class="navbar-brand" href="##" style="color:white;">บันทึกไมล์ออก</a>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
    
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" style="color:white;" href="/carlendar.html">ปฏิทินจองรถ</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" style="color:white;" href="/carlendarcus.html">ปฏิทินลูกค้า</a>
            </li>
    
            <li class="nav-item">
              <a class="nav-link" style="color:white;" href="/mileout.html">บันทึกไมล์ออก</a>
            </li>
          
            <li class="nav-item">
              <a class="nav-link" style="color:white;" href="/index.html">หน้าจองรถ</a>
            </li>
          </ul>
          <form class="d-flex" role="search">
            <!-- <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search"> -->
        <!-- <button type="button" onclick="logoutcar()" class="btn btn-danger"  style="margin-left: auto;">Logout</button> -->
          </form>
    
        
    
          </div>
        </div>
      </nav>


<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">บันทึกเลขไมล์ออก</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="myFormsave" onsubmit="saveData(event)" class="row g-2">
       
            <input type="text" class="form-control" id="editId" readonly hidden>

         <div class="col-12 col-md-6 mb-2">
            <label for="editNamebook" class="form-label">ชื่อผู้จอง:</label>
            <input type="text" class="form-control" id="editNamebook" name="editNamebook" style="color: blue;">
          </div>
          <div class="col-6 col-md-6 mb-2">
            <label for="editDepbook" class="form-label">แผนก:</label>
            <input type="text" class="form-control" id="editDepbook" name="editDepbook" style="color: blue;">
          </div>
          <div class="col-6 col-md-6 mb-2">
            <label for="editCarbook" class="form-label">รถที่จอง</label>
            <input type="text" class="form-control" id="editCarbook" name="editCarbook" style="color: blue;">
          </div>
          <div class="col-12 col-md-6 mb-2">
            <label for="editLocabook" class="form-label">สถานที่ๆไปติดต่อ</label>
            <input type="text" class="form-control" id="editLocabook" name="editLocabook" style="color: blue;">
          </div>

            <input type="date" class="form-control" id="editDateoutbook" name="editDateoutbook" style="display: none;">

            <input type="text" class="form-control" id="editTimeoutbook" name="editTimeoutbook" style="display: none;">

            <input type="text" class="form-control" id="editTimeinbook" name="editTimeinbook" style="display: none;">
     
 
            <input type="text" class="form-control" id="editDrivebook" name="editDrivebook" style="display: none;">
        


            <input type="text" class="form-control" id="editStatusbook" name="editStatusbook" value="กำลังใช้งาน" style="display: none;">
         
     
            <input type="text" class="form-control" id="editApproverbook" name="editApproverbook" style="display: none;">
        
          <div class="col-6 col-md-6 mb-2">
            <label for="editDateout" class="form-label">วันที่ออก</label>
            <input type="date" class="form-control" id="editDateout" name="editDateout" style="color: blue;">
          </div>
         <div class="col-6 col-md-6 mb-2">
            <label for="editTimeout" class="form-label">เวลาออก</label>
            <input type="time" class="form-control" id="editTimeout" name="editTimeout" style="color: blue;">
          </div>
          <div class="col-6 col-md-6 mb-2">
            <label for="editMileout" class="form-label">เลขไมล์ออก</label>
            <input type="tel" class="form-control" id="editMileout" name="editMileout" style="color: blue;">
          </div>
         <div class="col-6 col-md-6 mb-2">
            <label for="editDriver" class="form-label">ชื่อคนขับ</label>
            <input type="text" class="form-control" id="editDriver" name="editDriver" required>
          </div>
          <div class="col-12 col-md-12 mb-2">
            <label for="editOtherbook" class="form-label">อื่นๆ</label>
            <input type="text" class="form-control" id="editOtherbook" name="editOtherbook">
          </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
        <button type="submit" class="btn btn-primary" onclick="saveData(event)">บันทึก</button>
        </form>
      </div>
    </div>
  </div>
</div>

  <!-- Modal -->
  <div class="modal fade" id="addDataModal" tabindex="-1" aria-labelledby="addDataModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addDataModalLabel">เพิ่มข้อมูล</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- ฟอร์มเพิ่มข้อมูล -->
          <form id="addDataForm" onsubmit="booksubmitForm()">
         
            <div class="mb-3">
              <label for="addName" class="form-label">ชื่อ</label>
              <input type="text" class="form-control" id="addName" name="addName">
            </div>
            <div class="mb-3">
              <label for="addNickname" class="form-label">ชื่อเล่น</label>
              <input type="text" class="form-control" id="addNickname" name="addNickname">
            </div>
            <div class="mb-3">
              <label for="addNickname" class="form-label">เบอร์โทร</label>
              <input type="text" class="form-control" id="addTel" name="addTel">
            </div>
         
        </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ปิด</button>
           <button type="submit" onclick="booksubmitForm()" class="btn btn-primary">บันทึก</button>
         </div>
         </form>
      </div>
    </div>
  </div>

 

   <!-- <div class="container"> -->
    <div class="container table-responsive mt-4" id="container1">
    <table id="dataTable" class="table table-striped table-bordered" style="width:100%; font-size:12px;">
      <thead class="bg-success text-white">
        <tr id="tableHeader"></tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>
    <br>
  </div>
      <!-- </div> -->

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <!-- DataTables JavaScript -->
  <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
  <script>
  

    // เมื่อคลิกที่ปุ่ม "เพิ่มข้อมูล"
    $('.btn-warning').click(function() {
      // รีเซ็ตค่าในฟอร์มเพื่อเตรียมการเพิ่มข้อมูลใหม่
      $('#editId').val('');
      $('#editNamebook').val('');
      $('#editDepbook').val('');
      $('#editCarbook').val('');
      $('#editLocabook').val('');
      $('#editDateoutbook').val('');
      $('#editTimeoutbook').val('');
      $('#editTimeinbook').val('');
      $('#editDrivebook').val('');
      $('#editOtherbook').val('');
      $('#editStatusbook').val('');
      $('#editApproverbook').val('');
      $('#editDateout').val('');
      $('#editTimeout').val('');
      $('#editMileout').val('');
      $('#editDriver').val('');

      // แสดง modal เพื่อเพิ่มข้อมูล
      $('#addDataModal').modal('show');
    });

  


    function booksubmitForm() {
        event.preventDefault();
        Swal.fire({
            position: 'center',
            title: '<h4>กำลังบันทึกข้อมูล...</h4>',
            showConfirmButton: false,
        });
        Swal.showLoading();

        // Fetch data from the form
      
      var editNamebook = document.getElementById('editNamebook').value;
      var editDepbook = document.getElementById('editDepbook').value;
      var editCarbook = document.getElementById('editCarbook').value;
      var editLocabook = document.getElementById('editLocabook').value;
      var editDateoutbook = document.getElementById('editDateoutbook').value;
      var editTimeoutbook = document.getElementById('editTimeoutbook').value;
      var editTimeinbook = document.getElementById('editTimeinbook').value;
      var editDrivebook = document.getElementById('editDrivebook').value;
      var editOtherbook = document.getElementById('editOtherbook').value;
      var editStatusbook = document.getElementById('editStatusbook').value;
      var editApproverbook = document.getElementById('editApproverbook').value;
      var editDateout = document.getElementById('editDateout').value;
      var editTimeout = document.getElementById('editTimeout').value;
      var editMileout = document.getElementById('editMileout').value;
      var editDriver = document.getElementById('editDriver').value;


      var formData = new FormData(document.getElementById("addDataForm"));
      formData.append('action', 'submitFormadmin'); // เพิ่ม key "action" เพื่อบ่งบอกว่าเป็นการ submitForm
       fetch(googleScriptUrl, {
            method: 'POST',
            body: formData
        })
        .then(response => response.json()) // เปลี่ยนจาก response.text() เป็น response.json() เนื่องจากข้อมูลที่ส่งกลับมาเป็น JSON
        .then(data => {
            // Handle the successful response
            console.log(data);
            if (data == true) {
              document.getElementById("addDataForm").reset();
                Swal.fire({
                    position: 'center',
                    icon: 'success',
                    title: '<h4>บันทึกข้อมูลสำเร็จ</h4>',
                    showConfirmButton: false,
                    timer: 1500,
                });
              location.reload();
            } else {
                Swal.fire({
                    position: 'center',
                    icon: 'error',
                    title: '<h4>มีข้อมูลซ้ำ</h4>',
                    showConfirmButton: true,
                    confirmButtonText: 'OK',
                });
            }
        })
        .catch(error => {
            // Handle the error
            console.error('Error:', error);
        });
    }

  
    
function editData(button) {
  var index = $(button).data('index');
  var row = $(button).data('row');
  
  // ตั้งค่าข้อมูลใน input ใน modal
  $('#editId').val(row['ไอดี']);
  $('#editNamebook').val(row['ชื่อผู้จอง']);
  $('#editDepbook').val(row['แผนก']);
   $('#editCarbook').val(row['รถที่จอง']);
   $('#editLocabook').val(row['สถานที่ๆไปติดต่อ']);
   $('#editDateoutbook').val(row['วันที่ใช้รถ']);
   $('#editTimeoutbook').val(row['ออกเวลา']);
   $('#editTimeinbook').val(row['เข้าเวลา']);
   $('#editDrivebook').val(row['สถานะการขับ']);
   $('#editOtherbook').val(row['อื่นๆ']);
  // $('#editStatusbook').val(row['สถานะการจอง']);
   $('#editApproverbook').val(row['อนุมัติโดย']);
   $('#editDateout').val(row['วันที่ใช้รถ']);
   // $('#editTimeout').val(row['เบอร์โทร']);
   // $('#editMileout').val(row['เบอร์โทร']);
   // $('#editDriver').val(row['เบอร์โทร']);
  

  // กำหนดค่า index ของแถวที่ต้องการแก้ไขให้กับ modal
  $('#editModal').data('index', index);

  // แสดง modal
  $('#editModal').modal('show');
}

    function saveData(event) {
      event.preventDefault(); // หยุดการส่งค่าฟอร์มทางเบราว์เซอร์
    Swal.fire({
            position: 'center',
            title: '<h4>กำลังบันทึกข้อมูล...</h4>',
            showConfirmButton: false,
          })
           Swal.showLoading()
      // ดึงข้อมูลที่แก้ไขจาก input ใน modal
      var id = $('#editId').val();
      var editNamebook = $('#editNamebook').val();
      var editDepbook = $('#editDepbook').val();
      var editCarbook = $('#editCarbook').val();
      var editLocabook = $('#editLocabook').val();
      var editDateoutbook = $('#editDateoutbook').val();
      var editTimeoutbook = $('#editTimeoutbook').val();
      var editTimeinbook = $('#editTimeinbook').val();
      var editDrivebook = $('#editDrivebook').val();
      var editOtherbook = $('#editOtherbook').val();
      var editStatusbook = $('#editStatusbook').val();
      var editApproverbook = $('#editApproverbook').val();
      var editDateout = $('#editDateout').val();
      var editTimeout = $('#editTimeout').val();
      var editMileout = $('#editMileout').val();
      var editDriver = $('#editDriver').val();
     
      
      if (editTimeout == "") {
        Swal.fire({
          position: 'center',
          icon: 'error',
          title: '<h4>กรุณากรอกเวลาออก</h4>',
          showConfirmButton: true,
          confirmButtonText: 'OK',
        });
        return;
      } else if (editMileout == "") {
        Swal.fire({
          position: 'center',
          icon: 'error',
          title: '<h4>กรุณากรอกเลขไมล์ออก</h4>',
          showConfirmButton: true,
          confirmButtonText: 'OK',
        });
        return;
      }  else if (editDriver == "") {
        Swal.fire({
          position: 'center',
          icon: 'error',
          title: '<h4>กรุณาระบุชื่อคนขับ</h4>',
          showConfirmButton: true,
          confirmButtonText: 'OK',
        });
        return;
      }

      // สร้าง JSON object ที่มีข้อมูลที่แก้ไขแล้ว
      var editedData = {
        'ไอดี': id,
        'ชื่อผู้จอง': editNamebook,
        'แผนก': editDepbook,
        'รถที่จอง': editCarbook,
        'สถานที่ๆไปติดต่อ': editLocabook,
        'วันที่ใช้รถ': editDateoutbook,
        'ออกเวลา': editTimeoutbook,
        'เข้าเวลา': editTimeinbook,
        'สถานะการขับ': editDrivebook,
        'อื่นๆ': editOtherbook,
        'สถานะการจอง': editStatusbook,
        'อนุมัติโดย': editApproverbook,
        'วันที่ออก': editDateout,
        'เวลาออก': editTimeout,
        'เลขไมล์ออก': editMileout,
        'ชื่อผู้ขับขี่': editDriver
      };

      // แปลง JSON object เป็น string JSON
      var jsonData = JSON.stringify(editedData);

      fetch(googleScriptUrl, {
        method: 'POST',
        body: jsonData // ข้อมูลที่แก้ไข
      })
      .then(response => response.json()) // เปลี่ยนจาก response.text() เป็น response.json() เนื่องจากข้อมูลที่ส่งกลับมาเป็น JSON
      .then(data => {
        document.getElementById("myFormsave").reset();
       Swal.fire({
  position: 'center',
  icon: 'success',
  title: 'แก้ไขข้อมูลเรียบร้อยแล้ว',
  showConfirmButton: false,
  timer: 2500
})
        console.log(data);
        location.reload();
      })
      .catch(error => {
        console.error('Error:', error);
      });
    }








    var googleScriptUrl = 'https://script.google.com/macros/s/AKfycbwQLkv0w7KE3cLbb1DBPwjvG0oWxt-vZmG8D4yzI4omfmSoOkDdsXsQFVbxz1-XCkXZOw/exec'; // ใส่ URL ของ Google Apps Script ที่คุณสร้าง
$(document).ready(function() {
  $('#dataTable').html('<div class="spinner-container"><div class="spinner-border text-info me-2" role="status"></div> กำลังโหลดข้อมูล...</div>');

  $.ajax({
    url: googleScriptUrl,
    dataType: 'json',
    success: function(data) {
      // เมื่อโหลดข้อมูลเสร็จสิ้นซ่อน spinner
      $('#dataTable').empty();

      var headerRow = [
      
      { title: 'ไอดี', visible: false },
        { title: 'ชื่อผู้จอง' },
        { title: 'แผนก', visible: false  },
        { title: 'รถที่จอง' },
         { title: 'สถานที่ๆไปติดต่อ' },
         { title: 'วันที่ใช้รถ' , render: function (data) { return moment(data, 'YYYY-MM-DD').format('DD-MM-YYYY'); }},
         { title: 'ออกเวลา' },
         { title: 'เข้าเวลา' },
         { title: 'สถานะการขับ', visible: false  },
         { title: 'อื่นๆ', visible: false   },
         { title: 'สถานะการจอง', visible: false  },
         { title: 'อนุมัติโดย', visible: false  },
        { title: 'แก้ไข' }
       

      ];
      var tableRows = [];

      $.each(data, function(index, row) {
        var editButton = '<button type="button" onclick="editData(this);" class="btn btn-success edit-button" data-bs-toggle="modal" data-bs-target="#editModal" data-index="' + index + '" data-row=\'' + JSON.stringify(row) + '\'><i class="fa-solid fa-pen-to-square" style="color: white;"></i></button>';
        var deleteButton = '<button type="button" onclick="deleteData(\'' + row['ไอดี'] + '\');" class="btn btn-danger delete-button"><i class="fa-solid fa-trash-can" style="color: white;"></i></button>';

        // var actiondeleteButtons = '<div class="btn-group" role="group">' + deleteButton + '</div>';
        var actioneditButtons = '<div class="btn-group" role="group">' + editButton + '</div>';
        
        var rowData = [
         
          row['ไอดี'],
          row['ชื่อผู้จอง'],
          row['แผนก'],
          row['รถที่จอง'],
          row['สถานที่ๆไปติดต่อ'],
          row['วันที่ใช้รถ'],
          row['ออกเวลา'],
          row['เข้าเวลา'],
          row['สถานะการขับ'],
          row['อื่นๆ'],
          row['สถานะการจอง'],
          row['อนุมัติโดย'],
          actioneditButtons
         
        ];
        tableRows.push(rowData);
      });

      $('#dataTable').DataTable({
        data: tableRows,
        columns: headerRow,
        dom: 't',
        order: [[5, 'asc']]
      });
    },
    error: function(xhr, status, error) {
      console.error('Error fetching data:', status, error);
    }
  });
});


    // ฟังก์ชั่น deleteData เพื่อลบข้อมูล
    function deleteData(id) {
      Swal.fire({
        //title: "Are you sure?",
        text: "คุณต้องการลบข้อมูลใช่หรือไม่!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#3085d6",
        cancelButtonColor: "#d33",
        confirmButtonText: "ใช่ต้องการลบข้อมูล"
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
              position: 'center',
              title: '<h4>กำลังลบข้อมูล...</h4>',
              showConfirmButton: false,
          });
          Swal.showLoading();
          // ส่งข้อมูล ID ที่ต้องการลบไปยัง Google Apps Script ผ่าน AJAX request
          $.ajax({
            url: googleScriptUrl, // URL ของ Google Apps Script
            method: 'POST',
            dataType: 'json',
            data: { id: id }, // ส่งข้อมูล ID เพื่อลบ
            success: function(response) {
              if (response.success) {
                Swal.fire({
                  //title: "ลบข้อมูล",
                  text: "ลบข้อมุลเรียบร้อยแล้ว",
                  icon: "success"
                }).then(() => {
                  // รีโหลดหน้าหลังจากที่ข้อมูลถูกลบเรียบร้อย
                  location.reload();
                });
              } else {
                console.error('Error deleting data:', response.error);
                alert('An error occurred while deleting data. Please try again later.');
              }
            },
            error: function(xhr, status, error) {
              console.error('Error deleting data:', status, error);
              alert('An error occurred while deleting data. Please try again later.');
            }
          });
        }
      });
    }




  </script>
   <script src="script.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
